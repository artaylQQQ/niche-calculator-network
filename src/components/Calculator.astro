---
/** Calculator.astro — V017.7.gemini
  - Simplificado: usa atributos data-* para pasar slug y expression.
  - Sin JSON.parse necesario (aunque se mantiene opcional).
*/
import AdBanner from './AdBanner.astro';
import AiAssistant from './AiAssistant.astro';
import allCalcs from '../../data/calculators.json';
const { schema } = Astro.props;
const title = schema?.title ?? 'Calculator';
const slug = schema?.slug ?? 'calculator';
const inputs = Array.isArray(schema?.inputs) ? schema.inputs : [];
const intro = schema?.intro ?? '';
const expression = schema?.expression ?? schema?.formula ?? schema?.formula_expression ?? '';

const examples = Array.isArray(schema?.examples) && schema.examples.length
  ? schema.examples
  : [{ description: 'Enter the values and press Calculate.' }];
const faqs = Array.isArray(schema?.faqs) && schema.faqs.length
  ? schema.faqs
  : [{
      question: 'How do I use this calculator?',
      answer: 'Enter the required values and press Calculate to get the result.'
    }];

function pickRelated(slug: string, cluster: string): string[] {
  const same = allCalcs.filter(
    (c) => c.slug !== slug && c.cluster && c.cluster.toLowerCase() === (cluster || '').toLowerCase()
  );
  const pool = same.length >= 6 ? same : allCalcs.filter((c) => c.slug !== slug);
  return pool.slice(0, 6).map((c) => c.slug);
}

const related = Array.isArray(schema?.related) && schema.related.length
  ? schema.related
  : pickRelated(slug, schema?.cluster);

function titleize(s: string): string {
  return s.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
}

// Build Schema.org data for the calculator including FAQs when available.
const site = Astro.site?.toString() || (import.meta.env.SITE_URL ?? 'https://example.com');
const url  = new URL(Astro.url.pathname, site).toString();
const faqEntities = faqs.map((q) => ({
  '@type': 'Question',
  name: q.question,
  acceptedAnswer: { '@type': 'Answer', text: q.answer }
}));
const jsonLd = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'SoftwareApplication',
      name: title,
      operatingSystem: 'Any',
      applicationCategory: 'Calculator',
      url,
      description: intro,
      offers: { '@type': 'Offer', price: '0', priceCurrency: 'USD' }
    },
    { '@type': 'FAQPage', mainEntity: faqEntities }
  ]
};
---

<section
  class="calc"
  data-calculator
  data-slug={slug}
  data-exp={expression}
  data-unit={schema?.unit}
  aria-labelledby={`h-${slug}`}
>
  <h1 id={`h-${slug}`}>{title}</h1>
  {intro && <p class="muted">{intro}</p>}
  <AdBanner />

  <form data-role="form" onsubmit="compute(); return false">
    {inputs.map((i) => (
      <div class="field">
        <label for={`in-${slug}-${i.name}`}>{i.label ?? i.name}</label>
        <input
          id={`in-${slug}-${i.name}`}
          name={i.name}
          type="number"
          step={i.step ?? 'any'}
          {...(i.min !== undefined ? { min: i.min } : {})}
          {...(i.max !== undefined ? { max: i.max } : {})}
          inputmode="decimal"
          placeholder={i.placeholder ?? ''}
          aria-describedby={`hint-${slug}-${i.name}`}
        />
        <div id={`hint-${slug}-${i.name}`} class="hint">{i.hint ? i.hint : (i.units ? i.units : '')}</div>
      </div>
    ))}
    <button type="button" data-action="calc" class="btn">Calculate</button>
  </form>

  <div class="result" data-role="result" aria-live="polite"></div>

  <AiAssistant />

  <script type="application/json" data-schema set:html={JSON.stringify(schema)}></script>
</section>

<section class="examples">
  <h2>Examples</h2>
  <ul>
    {examples.map((ex) => (
      <li>{ex.description}</li>
    ))}
  </ul>
</section>

<section class="faq">
  <h2>FAQ</h2>
  {faqs.map((f) => (
    <details>
      <summary>{f.question}</summary>
      <p>{f.answer}</p>
    </details>
  ))}
</section>

<section class="related">
  <h2>Related calculators</h2>
  <ul>
    {related.map((r) => (
      <li><a href={`/calculators/${r}/`}>{titleize(r)}</a></li>
    ))}
  </ul>
</section>

<script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>

<style>
  .calc {
    max-width: 720px;
    margin: 0 auto;
    padding: 8px;
    color: var(--ink);
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  h1 { margin: 48px 0 8px; font-size: 28px; }
  .muted { color: var(--muted); margin: 0 0 16px; }
  .field { margin: 14px 0; }
  .field label { display:block; margin: 0 0 6px; font-weight: 600; }
  .field input[type=number], .field input, .field select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--card);
    color: var(--ink);
    box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.1),
      inset -2px -2px 4px rgba(255, 255, 255, 0.6);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .field input[type=number]:focus,
  .field input:focus,
  .field select:focus {
    border-color: var(--accent-red);
    box-shadow: 0 0 0 2px var(--accent-red);
    outline: none;
  }
  .btn {
    display: inline-block;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid var(--accent-red);
    background: var(--accent-red);
    color: var(--primary-ink);
    font-weight: 700;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: transform 0.2s;
  }
  .btn:hover,
  .btn:focus {
    transform: translateY(1px);
    filter: brightness(1.05);
  }
  .btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .result {
    margin-top: 16px;
    font-size: 18px;
    font-weight: 700;
    color: var(--bg);
    background: var(--bg);
    border-radius: var(--radius);
    box-shadow: none;
    padding: 12px;
    opacity: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
  }
  .result:not(:empty) {
    background: #b8860b;
    color: #ffffff;
    box-shadow: var(--shadow);
    opacity: 1;
    font-weight: 700;
  }
  .result .icon {
    font-size: 1.6em;
  }
  .examples,
  .faq,
  .related {
    max-width: 720px;
    margin: 24px auto 0;
    padding: 8px;
    color: var(--ink);
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .examples ul { margin: 8px 0 0 20px; }
  .faq details { margin: 8px 0; }
  .faq summary { cursor: pointer; font-weight: 600; }
  .faq p { margin: 4px 0 0 16px; }
  .related ul { margin: 8px 0 0 20px; }
</style>


<script is:inline>
(function () {
  // Parser seguro (shunting-yard)
  function evalExpr(expr, vars){
    let out=[], ops=[], prec={'^':4,'*':3,'/':3,'%':3,'+':2,'-':2}, right={'^':true}, i=0;
    function isSpace(c){return /\s/.test(c);} function isDigit(c){return c>='0'&&c<='9';} function isLetter(c){return /[A-Za-z_]/.test(c);}
    let tokens=[];
    while(i<expr.length){
      let c=expr[i];
      if(isSpace(c)){i++;continue;}
      if(isDigit(c)||c==='.'){let s=i; while(i<expr.length && /[0-9.eE+\-]/.test(expr[i])) i++; tokens.push({t:'num',v:parseFloat(expr.slice(s,i))}); continue;}
      if(isLetter(c)){let s2=i; while(i<expr.length && /[A-Za-z0-9_]/.test(expr[i])) i++; let name=expr.slice(s2,i); if(!(name in vars)) throw new Error('Unknown let '+name); tokens.push({t:'num',v:Number(vars[name])}); continue;}
      if('+-*/%^()'.indexOf(c)!==-1){tokens.push({t:'op',v:c}); i++; continue;}
      throw new Error('Bad char in expression');
    }
    for(let ti=0; ti<tokens.length; ti++){
      let tok=tokens[ti];
      if(tok.t==='num'){out.push(tok); continue;}
      let op=tok.v;
      if(op==='('){ops.push(op); continue;}
      if(op===')'){while(ops.length && ops[ops.length-1]!=='(') out.push({t:'op',v:ops.pop()}); ops.pop(); continue;}
      while(ops.length){
        let top=ops[ops.length-1]; if(top==='(') break;
        if((right[op] && prec[op] < prec[top]) || (!right[op] && prec[op] <= prec[top])) out.push({t:'op',v:ops.pop()}); else break;
      }
      ops.push(op);
    }
    while(ops.length) out.push({t:'op',v:ops.pop()});
    let st=[];
    for(let oi=0; oi<out.length; oi++){
      let t=out[oi]; if(t.t==='num'){st.push(t.v); continue;}
      let b=st.pop(), a=st.pop(), r;
      switch(t.v){
        case '+': r=a+b; break;
        case '-': r=a-b; break;
        case '*': r=a*b; break;
        case '/': r=b===0?NaN:a/b; break;
        case '%': r=b===0?NaN:a%b; break;
        case '^': r=Math.pow(a,b); break;
        default: throw new Error('op');
      }
      st.push(r);
    }
    return st.pop();
  }

  function fmt(n){
    return isFinite(n)
      ? new Intl.NumberFormat('en-US', { maximumFractionDigits: 3 }).format(n)
      : '—';
  }
  function num(v){ let n=Number(v); return isFinite(n)?n:NaN; }

  function initCalc(root){
    if (!root || root.__calcInit) return;
    root.__calcInit = true;
    let form = root.querySelector('[data-role="form"]');
    let resultEl = root.querySelector('[data-role="result"]');
    let btn = root.querySelector('[data-action="calc"]');
    if (!form || !resultEl || !btn) return;
    let slug = root.getAttribute('data-slug') || 'calculator';
    let expr = root.getAttribute('data-exp') || '';
    
    function readInputs(){
      let out={};
      let fields = form.querySelectorAll('input[name]');
      fields.forEach(function(el){
        let v = el.value;
        out[el.name] = (v!=='' ? Number(v) : NaN);
      });
      return out;
    }

    function showMessage(type, msg) {
      const icon = type === 'error' ? '⚠️' : '✅';
      resultEl.innerHTML = `<span class="icon" aria-hidden="true">${icon}</span><span>${msg}</span>`;
      resultEl.dataset.state = type;
      resultEl.setAttribute('role', type === 'error' ? 'alert' : 'status');
    }

    // Compute function handles validation, expression evaluation and fallbacks.
    window.compute = function(){
      const vars = readInputs();
      // validate all inputs are finite numbers
      for (const k in vars) {
        if (!isFinite(vars[k])) {
          showMessage('error', 'Please fill all fields with valid numbers');
          return;
        }
      }
      let value;
      let usedExpr = false;
      // If an expression is defined on the element evaluate it safely
      if (expr) {
        // ensure every symbol referenced in the expression is provided in vars
        const varNames = expr.match(/[A-Za-z_][A-Za-z0-9_]*/g) || [];
        const unknown = varNames.filter(n => !(n in vars));
        if (unknown.length) {
          showMessage('error', 'Unknown variable: ' + unknown[0]);
          return;
        }
        try {
          value = evalExpr(expr, vars);
          usedExpr = isFinite(value);
        } catch (e) {
          usedExpr = false;
        }
      }
      // When expression evaluation is unavailable use per‑calculator fallbacks
      if (!usedExpr) {
        switch (slug) {
          case 'loan-payment-calculator': {
            // Monthly loan payment. Accept either annualRate/years or rate/months fields.
            const P = num(vars.principal);
            const annualRate = ('rate' in vars ? num(vars.rate) : num(vars.annualRate));
            const months = ('months' in vars ? num(vars.months) : num(vars.years) * 12);
            if (!isFinite(P) || !isFinite(months) || months === 0) {
              showMessage('error', 'Please fill all fields with valid numbers');
              return;
            }
            const r = annualRate / 100 / 12;
            value = (r === 0) ? (P / months) : (P * r) / (1 - Math.pow(1 + r, -months));
            break;
          }
          case 'percentage-discount-calculator': {
            value = num(vars.price) * (1 - num(vars.discount) / 100);
            break;
          }
          case 'percentage-increase-calculator': {
            value = num(vars.original) * (1 + num(vars.increase) / 100);
            break;
          }
          case 'final-price-calculator': {
            value = num(vars.price) * (1 + num(vars.percent) / 100);
            break;
          }
          case 'sales-tax-calculator': {
            value = num(vars.price) * (1 + num(vars.tax) / 100);
            break;
          }
          case 'net-profit-calculator': {
            value = num(vars.revenue) - num(vars.costs);
            break;
          }
          case 'roi-dollar-calculator': {
            value = num(vars.investment) * num(vars.roiPercent) / 100;
            break;
          }
          case 'roi-calculator': {
            value = ((num(vars.gain) - num(vars.cost)) / num(vars.cost)) * 100;
            break;
          }
          case 'simple-interest-calculator': {
            value = (num(vars.principal) * num(vars.rate) * num(vars.years)) / 100;
            break;
          }
          case 'cagr-calculator': {
            const fVal = num(vars.final);
            const iVal = num(vars.initial);
            const yVal = num(vars.years);
            if (iVal === 0 || !isFinite(fVal) || !isFinite(iVal) || !isFinite(yVal) || yVal === 0) {
              showMessage('error', 'Please fill all fields with valid numbers');
              return;
            }
            value = (Math.pow(fVal / iVal, 1 / yVal) - 1) * 100;
            break;
          }
          case 'bmi-calculator': {
            const h = num(vars.height);
            value = num(vars.weight) / (h * h);
            break;
          }
          case 'weight-to-bmi-projection-calculator': {
            // height is in cm – convert to meters if >3
            const hCm = num(vars.height);
            const wKg = num(vars.weight);
            const hM = hCm > 3 ? hCm / 100 : hCm;
            value = wKg / (hM * hM);
            break;
          }
          case 'break-even-calculator': {
            const fixed = num(vars.fixed);
            const variable = num(vars.variable);
            const price = num(vars.price);
            if (price <= variable) {
              showMessage('error', 'Price must be greater than variable cost.');
              return;
            }
            value = fixed / (price - variable);
            break;
          }
          case 'markup-margin-calculator': {
            value = num(vars.cost) / (1 - num(vars.margin) / 100);
            break;
          }
          case 'compound-interest-calculator': {
            const P2 = num(vars.principal);
            const r2 = num(vars.rate) / 100;
            const t2 = num(vars.years);
            const n2 = num(vars.times);
            value = P2 * Math.pow(1 + r2 / n2, n2 * t2);
            break;
          }
          case 'triangle-area-calculator': {
            value = (num(vars.base) * num(vars.height)) / 2;
            break;
          }
          case 'rectangle-area-calculator': {
            value = num(vars.length) * num(vars.width);
            break;
          }
          case 'circle-area-calculator': {
            const r = num(vars.radius);
            value = 3.141592653589793 * r * r;
            break;
          }
          case 'cylinder-volume-calculator': {
            const r = num(vars.radius);
            value = 3.141592653589793 * r * r * num(vars.height);
            break;
          }
          case 'c-to-f-calculator': {
            value = num(vars.c) * 9 / 5 + 32;
            break;
          }
          case 'f-to-c-calculator': {
            value = (num(vars.f) - 32) * 5 / 9;
            break;
          }
          case 'km-to-miles-calculator': {
            value = num(vars.km) * 0.621371;
            break;
          }
          case 'miles-to-km-calculator': {
            value = num(vars.miles) * 1.60934;
            break;
          }
          case 'cm-to-inches-calculator': {
            value = num(vars.cm) / 2.54;
            break;
          }
          case 'kg-to-g-calculator': {
            value = num(vars.kg) * 1000;
            break;
          }
          case 'kg-to-lb-calculator': {
            value = num(vars.kg) * 2.20462;
            break;
          }
          case 'hours-to-minutes-calculator': {
            value = num(vars.hours) * 60;
            break;
          }
          case 'time-to-seconds-calculator': {
            value = num(vars.hours) * 3600 + num(vars.minutes) * 60 + num(vars.seconds);
            break;
          }
          case 'rule-of-three-calculator': {
            value = num(vars.b) * num(vars.c) / num(vars.a);
            break;
          }
          default: {
            showMessage('error', 'Calculation not available.');
            return;
          }
        }
      }
      // Determine output unit: if a unit is defined in data-unit attribute use it; otherwise pick currency for finance slugs
      let unit = root.getAttribute('data-unit') || '';
      if (!unit) {
        const slugName = root.getAttribute('data-slug') || '';
        const isMoney = /loan|mortgage|payment|interest|profit|tax|salary|revenue|cost|price|roi|net/i.test(slugName);
        if (isMoney) unit = '$';
      }
      // Render result with proper formatting
      if (unit === '$' || unit === '€' || unit === '£') {
        showMessage('success', 'Result: ' + unit + fmt(value));
      } else {
        showMessage('success', 'Result: ' + fmt(value) + (unit ? (' ' + unit) : ''));
      }
    };

    // Disable calculate button until all fields have valid numbers
    function updateButton() {
      const vars = readInputs();
      let valid = true;
      for (const k in vars) {
        if (!isFinite(vars[k])) { valid = false; break; }
      }
      btn.disabled = !valid;
    }
    form.addEventListener('input', updateButton);
    // initialize button state
    updateButton();

    btn.addEventListener('click', compute);
  }

  function boot(){
    let nodes = document.querySelectorAll('[data-calculator]');
    if (!nodes || !nodes.length) return;
    nodes.forEach(initCalc);
  }

  if (document.readyState !== 'loading') boot();
  else document.addEventListener('DOMContentLoaded', boot);
})();
</script>
