---
import BaseLayout from '../../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

/** Genera rutas y datos sin variables globales */
export async function getStaticPaths() {
  // 1) Define the eight supported category slugs and a list of aliases.  The
  // generator and pages normalise arbitrary cluster names using these
  // mappings.  Any calculator whose cluster matches (case insensitive)
  // one of the listed aliases will be grouped into the corresponding
  // category page.
  const CATEGORIES = [
    { slug: 'finance',     map: ['finance','finance & loans','taxes','business','business & commerce','percentages & ratios'] },
    { slug: 'health',      map: ['health','health & fitness','bmi'] },
    { slug: 'conversions', map: ['conversions','unit conversions','unit and currency conversions'] },
    { slug: 'math',        map: ['math','geometry','geometry & math','areas & volumes','algebra','statistics','averages and probabilities'] },
    { slug: 'technology',  map: ['technology','tech','computing','technology & computing'] },
    { slug: 'date-time',   map: ['date & time','time & date','time-date','durations and schedules'] },
    { slug: 'home-diy',    map: ['home & diy','home and diy','diy','household'] },
    { slug: 'other',       map: ['other','misc','miscellaneous','everyday','everyday & misc','general'] }
  ];

  // 2) Lee calculators.json en build
  const __filename = fileURLToPath(import.meta.url);
  const __dirname  = path.dirname(__filename);
  const dataPath   = path.resolve(__dirname, '../../../data/calculators.json');

  let calcs = [];
  try {
    calcs = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
  } catch (e) {
    console.warn('Could not read calculators.json at build time:', e?.message);
    calcs = [];
  }

  // 3) Para cada categoría, calcula su lista y la pasa en props
  return CATEGORIES.map((cat) => {
    const list = Array.isArray(calcs)
      ? calcs.filter((it) =>
          (it?.cluster ?? '') &&
          cat.map.some((v) => (it.cluster || '').toLowerCase().includes(v.toLowerCase()))
        ).slice(0, 200)
      : [];

    return {
      params: { slug: cat.slug },
      props:  { cat, list }
    };
  });
}

// Recibe cat y list ya preparados desde getStaticPaths
const { cat, list = [] } = Astro.props;
// Compute a human friendly title from the slug.  Replace hyphens with
// spaces and capitalise each word.  E.g. 'date-time' → 'Date Time'.
const catTitle = cat.slug
  .replace(/-/g, ' ')        // hyphens to spaces
  .replace(/\b\w/g, (c) => c.toUpperCase());
---

<BaseLayout title={`${catTitle} calculators`} description={`Browse ${catTitle} calculators`}>
  <section class="hero container mx-auto max-w-5xl px-4 pt-10">
    <h1 style="color: var(--ink)">{catTitle} Calculators</h1>
    <p style="color: var(--muted)">Explore calculators in this category.</p>
  </section>

  {list.length === 0 ? (
    <section class="section container mx-auto max-w-5xl px-4">
      <p>
        We’re working on new calculators for this category. Meanwhile, explore our other
        categories <a href="/categories/" class="underline">here</a>.
      </p>
    </section>
  ) : (
    <section class="section container mx-auto max-w-5xl px-4 py-8" aria-labelledby="cat-list">
      <h2 id="cat-list" class="sr-only">Calculators list</h2>
      <!-- Use a div container instead of ul/li to avoid any list markers or pseudo‑elements causing bracket artifacts -->
      <div class="cards-grid">
        {list.map((c) => (
          <div>
            <a class="card" href={`/calculators/${c.slug}/`}>
              <h3>{c.title}</h3>
              <p>{c.intro ?? ''}</p>
            </a>
          </div>
        ))}
      </div>
    </section>
  )}
</BaseLayout>
